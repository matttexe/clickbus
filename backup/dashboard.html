<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClickBus | Enterprise Challenge 2025 ‚Äî Dashboard (Definitivo)</title>

  <link rel="icon" href="assets/logo.png" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>

  <script src="data.js"></script>

  <style>
    /* ==========================
       THEME & TOKENS (Paleta ClickBus)
       ========================== */
    :root{
      --bg: #F8F9FA; --surface: #ffffff; --text: #1a1a1a; --muted: #6c757d;
      --brand: #6826D2; --brand-2:#8954e0; --brand-3:#3c0f81; --ok:#2A9D8F; --warn:#F4A261;
      --shadow: 0 10px 25px rgba(0,0,0,.06); --ring: 0 0 0 3px rgba(104, 38, 210, .15);
    }
    body.dark{
      --bg: #14181d; --surface:#1f2329; --text:#e8eaed; --muted:#a1a7b0;
      --brand:#9a67ea; --brand-2:#b28af0; --brand-3:#c7abf5; --ok:#5eead4; --warn:#fbbf24;
      --shadow: 0 10px 25px rgba(0,0,0,.35); --ring: 0 0 0 3px rgba(154, 103, 234, .15);
    }

    /* ==========================
       LAYOUT
       ========================== */
    html,body{height:100%}
    body{font-family:'Poppins',sans-serif;background:var(--bg);color:var(--text);display:flex}
    #sidebar{
      width: 300px; background: var(--surface); height: 100vh; position: fixed; inset-block:0; inset-inline-start:0;
      box-shadow: var(--shadow); display:flex; flex-direction:column; padding: 1.25rem 1.25rem 0.5rem;
    }
    .logo{height:40px; margin-bottom:1rem}
    #main-content{margin-inline-start:300px; width:calc(100% - 300px); padding: 1.5rem 2rem}

    /* Nav */
    #main-nav .nav-link{color:var(--text); opacity:.8; border-radius:10px; padding:.65rem .8rem; font-weight:600}
    #main-nav .nav-link i{margin-right:.5rem}
    #main-nav .nav-link.active,#main-nav .nav-link:hover{background:var(--brand); color:#fff}

    /* Filters */
    .filters h6{font-weight:700; margin-top:.5rem}
    .kpi-card,.card-surface,.chart-container,.table-container{background:var(--surface); border-radius:16px; box-shadow:var(--shadow)}
    .kpi-card{ padding:1rem; text-align:center; position:relative; overflow:hidden}
    .kpi-card .kpi-value{font-size:2rem; font-weight:800; color:var(--brand-3)}
    .kpi-card .badge{position:absolute; inset:12px 12px auto auto}
    .kpi-card .text-bg-danger { background-color: var(--brand) !important; } /* Ajuste para o badge */
    .kpi-card .text-bg-primary { background-color: var(--brand-2) !important; }
    .kpi-card .text-bg-warning { background-color: var(--warn) !important; color: #fff !important; }


    .page{display:none; animation: fadeUp .45s ease}
    .page.active{display:block}

    @keyframes fadeUp{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}
    .fade-in{animation: fadeUp .45s ease}

    h1,h2,h3{color:var(--brand-3); font-weight:800}
    .muted{color:var(--muted)}
    .chip{display:inline-flex; gap:.35rem; align-items:center; background:rgba(0,0,0,.04); color:var(--text); padding:.25rem .55rem; border-radius:999px; font-size:.85rem}
    body.dark .chip{background:rgba(255,255,255,.08)}

    /* Leaflet dark tweaks */
    body.dark .leaflet-container{filter: saturate(.9) brightness(.92)}

    /* ==========================
       BOT√ïES FLUTUANTES (MELHORIA)
       ========================== */
    .floating-controls {
      position: fixed;
      inset: 16px 16px auto auto;
      z-index: 1000;
      display: flex;
      gap: 0.5rem;
      background: var(--surface);
      padding: 0.5rem;
      border-radius: 999px; /* Formato de p√≠lula */
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
    }
    body.dark .floating-controls {
        border-color: rgba(255,255,255,0.1);
    }
    .floating-btn {
        background: transparent;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%; /* Bot√µes circulares */
        display: grid;
        place-items: center;
        font-size: 1.15rem;
        color: var(--muted);
        cursor: pointer;
        transition: all .2s ease-in-out;
    }
    .floating-btn:hover {
        color: var(--brand);
        background-color: rgba(104, 38, 210, 0.1);
    }
  </style>
</head>
<body>
  <div class="floating-controls">
    <button id="themeToggle" class="floating-btn" title="Alternar tema"><i class="bi bi-moon-stars"></i></button>
    <button id="btnExportPNGs" class="floating-btn" title="Exportar PNG dos gr√°ficos"><i class="bi bi-image"></i></button>
  </div>

  <nav id="sidebar" aria-label="Navega√ß√£o lateral">
    <div class="d-flex align-items-center mb-2" id="brandwrap">
      <img id="brandLogo" class="logo" src="assets/logo.png" alt="ClickBus"
           onerror="(function(el){const box=document.createElement('div');box.style.fontWeight='800';box.style.fontSize='1.25rem';box.textContent='ClickBus'; el.replaceWith(box);})(this)"/>
    </div>

    <ul id="main-nav" class="nav flex-column nav-pills">
      <li class="nav-item"><a class="nav-link active" data-page="page-overview" href="#"><i class="bi bi-bar-chart-line-fill"></i> Vis√£o Geral</a></li>
      <li class="nav-item"><a class="nav-link" data-page="page-eda" href="#"><i class="bi bi-search"></i> An√°lise Explorat√≥ria</a></li>
      <li class="nav-item"><a class="nav-link" data-page="page-segmentation" href="#"><i class="bi bi-person-bounding-box"></i> Segmenta√ß√£o</a></li>
      <li class="nav-item"><a class="nav-link" data-page="page-prediction" href="#"><i class="bi bi-robot"></i> Modelo Preditivo</a></li>
      <li class="nav-item"><a class="nav-link" data-page="page-recommendation" href="#"><i class="bi bi-lightbulb-fill"></i> Recomenda√ß√µes</a></li>
    </ul>

    <div class="filters mt-3">
      <h6><i class="bi bi-funnel-fill"></i> Filtros</h6>
      <label class="form-label mb-1">Per√≠odo</label>
      <input type="date" id="start-date" class="form-control" />
      <input type="date" id="end-date" class="form-control mt-1" />

      <label class="form-label mt-3 mb-1">Estado de Origem</label>
      <select id="filter-origem" class="form-select"></select>

      <div id="active-filters" class="mt-3 d-flex flex-wrap gap-2"></div>
      <button id="btn-reset-filtros" class="btn btn-sm btn-outline-secondary mt-2 w-100">
        <i class="bi bi-sliders"></i> Resetar filtros
      </button>
    </div>

    <div class="mt-auto text-center small muted py-3">
      <div>Enterprise Challenge ‚Äî FIAP √ó ClickBus</div>
      <div>¬© 2025</div>
    </div>
  </nav>

  <main id="main-content">
    <div class="offcanvas offcanvas-end" tabindex="-1" id="campanhaOffcanvas" aria-labelledby="campanhaLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="campanhaLabel"><i class="bi bi-megaphone-fill"></i> Ativar Campanha</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
      </div>
      <div class="offcanvas-body">
        <div class="mb-3">
          <label class="form-label">Objetivo</label>
          <select id="camp-objetivo" class="form-select">
            <option>Reativa√ß√£o</option>
            <option>Upsell</option>
            <option>Fideliza√ß√£o</option>
          </select>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Segmento</label>
            <input id="camp-segmento" class="form-control" placeholder="Ex.: Viajante Econ√¥mico" />
          </div>
          <div class="col-6">
            <label class="form-label">UF (contexto)</label>
            <input id="camp-uf" class="form-control" readonly />
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label">Mensagem</label>
          <textarea id="camp-msg" class="form-control" rows="4" placeholder="üéüÔ∏è 15% OFF na sua pr√≥xima viagem! C√≥digo: VOLTE15"></textarea>
        </div>
        <div class="d-flex gap-2 mt-3">
          <button id="btn-export" class="btn btn-outline-secondary"><i class="bi bi-download"></i> Exportar CSV (lista alvo)</button>
          <button id="btn-simular" class="btn btn-danger" style="background-color: var(--brand); border:none;"><i class="bi bi-rocket-fill"></i> Simular Disparo</button>
        </div>
        <hr/>
        <div class="small muted">O CSV inclui perfil, origem, UF, propens√£o e data da √∫ltima compra do recorte atual.</div>
      </div>
    </div>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1200">
      <div id="toastOk" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">Simula√ß√£o enviada! (mock)</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
        </div>
      </div>
    </div>

    <section id="page-overview" class="page active">
      <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
        <div>
          <h1 class="mb-0"><i class="bi bi-bar-chart-line-fill"></i> Vis√£o Geral do Neg√≥cio</h1>
          <p class="muted mb-0">Indicadores e convers√µes (simulado) ‚Äî totalmente reativos aos filtros e cross-filter.</p>
        </div>
        <div class="chip"><i class="bi bi-lightning-charge-fill"></i> Ao vivo pelos filtros</div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-12 col-md-4">
          <div class="kpi-card fade-in">
            <span class="badge rounded-pill text-bg-danger">Receita</span>
            <h6 class="mb-1 muted">Receita Total</h6>
            <div id="kpi-receita" class="kpi-value">R$ 0,00</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="kpi-card fade-in">
            <span class="badge rounded-pill text-bg-primary">Vendas</span>
            <h6 class="mb-1 muted">Passagens Vendidas</h6>
            <div id="kpi-passagens" class="kpi-value">0</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="kpi-card fade-in">
            <span class="badge rounded-pill text-bg-warning">Ticket</span>
            <h6 class="mb-1 muted">Ticket M√©dio</h6>
            <div id="kpi-ticket-medio" class="kpi-value">R$ 0,00</div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-12 col-lg-7">
          <div class="chart-container p-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <h3 class="mb-0">Mapa de Receita por Estado</h3>
                <small class="muted">Choropleth interativo ‚Äî clique para aplicar cross-filter.</small>
              </div>
              <button id="reset-map" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-counterclockwise"></i> Limpar sele√ß√£o</button>
            </div>
            <div id="br-map" style="height:420px; border-radius:12px; overflow:hidden; margin-top:8px"></div>
          </div>
        </div>
        <div class="col-12 col-lg-5">
          <div class="chart-container p-3">
            <h3 class="mb-0">Vendas por Dia da Semana</h3>
            <small class="muted">Clique em um dia para filtrar os demais gr√°ficos.</small>
            <div id="dayofweek-chart" style="height:360px"></div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-12 col-lg-7">
          <div class="chart-container p-3">
            <h3 class="mb-0">Funil de Convers√£o (simulado)</h3>
            <small class="muted">Visitantes ‚Üí Busca ‚Üí Carrinho ‚Üí Compra</small>
            <div id="funnel-chart" style="height:380px"></div>
          </div>
        </div>
        <div class="col-12 col-lg-5">
          <div class="chart-container p-3">
            <h3 class="mb-0">Tend√™ncia Mensal de Receita</h3>
            <small class="muted">Sazonalidade e crescimento</small>
            <div id="line-chart" style="height:360px"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="page-eda" class="page">
      <h1 class="mb-0"><i class="bi bi-search"></i> An√°lise Explorat√≥ria</h1>
      <p class="muted">Correla√ß√£o entre vari√°veis (simulada) e distribui√ß√£o de perfis.</p>
      <div class="row g-3 mt-1">
        <div class="col-12">
          <div class="chart-container p-3">
            <h3 class="mb-0">Heatmap de Correla√ß√£o</h3>
            <small class="muted">Correla√ß√£o de Pearson entre Ticket, Anteced√™ncia (sim.), Propens√£o, Passagens</small>
            <div id="corr-heatmap" style="height:420px"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="page-segmentation" class="page">
      <h1 class="mb-0"><i class="bi bi-person-bounding-box"></i> Segmenta√ß√£o de Clientes (ML)</h1>
      <p class="muted">Distribui√ß√£o proporcional de perfis ‚Äî responsivo aos filtros.</p>
      <div class="row g-3 mt-1">
        <div class="col-12">
          <div class="chart-container p-3">
            <h3 class="mb-0">Distribui√ß√£o dos Perfis</h3>
            <div id="pie-chart-segmentos" style="height:380px"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="page-prediction" class="page">
      <h1 class="mb-0"><i class="bi bi-robot"></i> Modelo Preditivo (ML)</h1>
      <p class="muted">Clientes com alta propens√£o de recompra nos pr√≥ximos 30 dias.</p>
      <div class="table-container p-3">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <div class="d-flex align-items-center gap-2">
            <h3 class="mb-0"><i class="bi bi-bullseye"></i> Alta Propens√£o (> 70%)</h3>
            <button id="btn-abrir-campanha" class="btn btn-sm text-white" style="background:var(--brand);"><i class="bi bi-megaphone-fill"></i> Ativar Campanha</button>
          </div>
          <div class="d-flex gap-2">
            <button id="btn-export-rapido" class="btn btn-sm btn-outline-secondary"><i class="bi bi-download"></i> Exportar CSV</button>
            <span id="sel-ctx" class="chip">Contexto: global</span>
          </div>
        </div>
        <div style="max-height: 420px; overflow:auto; margin-top:8px">
          <table class="table table-hover align-middle">
            <thead>
              <tr><th>Perfil</th><th>√öltima Origem</th><th>Propens√£o</th><th>A√ß√£o</th></tr>
            </thead>
            <tbody id="prediction-table"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="page-recommendation" class="page">
      <h1 class="mb-0"><i class="bi bi-lightbulb-fill"></i> Recomenda√ß√µes</h1>
      <p class="muted">T√°ticas acion√°veis a partir dos insights.</p>
      <div class="list-group">
        <a class="list-group-item list-group-item-action" href="#"><div class="d-flex w-100 justify-content-between"><h5 class="mb-1">Campanha de Reativa√ß√£o</h5></div><p class="mb-1">Voucher de 15% para <strong>‚ÄúViajante Econ√¥mico‚Äù</strong> com propens√£o &lt; 0.30.</p></a>
        <a class="list-group-item list-group-item-action" href="#"><div class="d-flex w-100 justify-content-between"><h5 class="mb-1">Programa de Fidelidade</h5></div><p class="mb-1">Benef√≠cios progressivos a cada 10 viagens para <strong>‚ÄúClientes Fi√©is‚Äù</strong>.</p></a>
        <a class="list-group-item list-group-item-action" href="#"><div class="d-flex w-100 justify-content-between"><h5 class="mb-1">Otimiza√ß√£o de Rotas</h5></div><p class="mb-1">Refor√ßar oferta em SP e RJ √†s sextas-feiras (pico de compras).</p></a>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // =========================================================
  // UTILIT√ÅRIOS & ESTADO GLOBAL
  // =========================================================
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const fmtMoney = (val) => {
    if (val == null || isNaN(val)) return 'R$ 0,00';
    return val.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
  };
  const fmtInt = (v) => (v||0).toLocaleString('pt-BR');

  // Cross-filter state
  const Cross = { estado: null, weekday: null };

  // Tema
  document.getElementById('themeToggle').addEventListener('click', () => {
    document.body.classList.toggle('dark');
    // Atualiza o tema dos gr√°ficos que n√£o mudam automaticamente
    setTimeout(() => {
        charts.funnel.dispose();
        charts.funnel = echarts.init(document.getElementById('funnel-chart'));
        renderAll();
    }, 10);
  });

  // Download helper
  function downloadURI(uri, filename){ const a=document.createElement('a'); a.href=uri; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>a.remove(),0); }

  // =========================================================
  // PREPARO DOS DADOS
  // =========================================================
  let DATA = [];
  let estadosLista = ['Todos'];
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof rawData === 'undefined' || !Array.isArray(rawData) || rawData.length===0) return;

    DATA = rawData.map(d => {
      const dt = new Date(d.data);
      const estado_origem = d.origem ? (d.origem.split(', ')[1]||'N/A') : 'N/A';
      const pass = Math.max(1, Number(d.passagens||1));
      const ticket = Number(d.receita||0) / pass;
      const seed = (dt.getFullYear()*10000 + (dt.getMonth()+1)*100 + dt.getDate() + estado_origem.charCodeAt(0)) % 97;
      const antecedencia = 1 + (seed % 25); // 1..25 dias (simula√ß√£o)
      return {
        ...d,
        dataObj: dt,
        estado_origem,
        dia_semana_num: dt.getDay(), // 0=Dom
        dia_semana_txt: dt.toLocaleDateString('pt-BR',{weekday:'long'}),
        ticket_valor: ticket,
        antecedencia,
        pass_num: pass,
      };
    });

    // Min/Max datas para filtros
    const minDate = new Date(Math.min(...DATA.map(d=>d.dataObj.getTime())));
    const maxDate = new Date(Math.max(...DATA.map(d=>d.dataObj.getTime())));
    const startEl = document.getElementById('start-date');
    const endEl = document.getElementById('end-date');
    startEl.value = minDate.toISOString().split('T')[0];
    endEl.value = maxDate.toISOString().split('T')[0];

    // Estados √∫nicos
    const setEstados = new Set(DATA.map(d=>d.estado_origem));
    estadosLista = ['Todos', ...Array.from(setEstados).sort()];
    const sel = document.getElementById('filter-origem');
    sel.innerHTML = estadosLista.map(e=>`<option value="${e}">${e}</option>`).join('');

    // Eventos filtros globais
    [startEl, endEl, sel].forEach(el=> el.addEventListener('change', ()=>{ Cross.estado = (sel.value==='Todos')? null : sel.value; updateActiveChips(); renderAll(); }));

    // Navega√ß√£o
    const navLinks = $$('#main-nav .nav-link');
    const pages = $$('.page');
    navLinks.forEach(link=>{
      link.addEventListener('click', (e)=>{
        e.preventDefault();
        navLinks.forEach(l=>l.classList.remove('active'));
        pages.forEach(p=>p.classList.remove('active'));
        link.classList.add('active');
        document.getElementById(link.dataset.page).classList.add('active');
        $$('#'+link.dataset.page+' .chart-container, #'+link.dataset.page+' .kpi-card').forEach(c=>{c.classList.remove('fade-in'); void c.offsetWidth; c.classList.add('fade-in')});
        renderAll();
      });
    });

    // Reset mapa e filtros
    document.getElementById('reset-map').addEventListener('click', ()=>{ Cross.estado=null; document.getElementById('filter-origem').value='Todos'; updateActiveChips(); renderAll(); });
    document.getElementById('btn-reset-filtros').addEventListener('click', resetFilters);

    // Export PNGs
    document.getElementById('btnExportPNGs').addEventListener('click', exportPNGs);

    initCharts();
    renderAll();
  });

  function getFilterBounds(){
    const start = new Date(document.getElementById('start-date').value);
    const end = new Date(document.getElementById('end-date').value);
    end.setHours(23,59,59,999);
    return {start,end};
  }
  function resetFilters(){
    if(!DATA.length) return;
    const minDate = new Date(Math.min(...DATA.map(d=>d.dataObj)));
    const maxDate = new Date(Math.max(...DATA.map(d=>d.dataObj)));
    document.getElementById('start-date').value = minDate.toISOString().split('T')[0];
    document.getElementById('end-date').value = maxDate.toISOString().split('T')[0];
    Cross.estado = null; Cross.weekday = null;
    document.getElementById('filter-origem').value = 'Todos';
    updateActiveChips();
    renderAll();
  }

  function filterData(){
    const {start,end} = getFilterBounds();
    return DATA.filter(d=> d.dataObj>=start && d.dataObj<=end && (!Cross.estado || d.estado_origem===Cross.estado) && (Cross.weekday==null || d.dia_semana_num===Cross.weekday));
  }

  function updateActiveChips(){
    const wrap = document.getElementById('active-filters');
    const chips = [];
    const {start,end}=getFilterBounds();
    chips.push(`<span class="chip"><i class="bi bi-calendar3"></i> ${start.toLocaleDateString()} ‚Äî ${end.toLocaleDateString()}</span>`);
    chips.push(`<span class="chip"><i class="bi bi-geo-alt"></i> ${Cross.estado || 'Todos os estados'}</span>`);
    chips.push(`<span class="chip"><i class="bi bi-calendar-week"></i> ${Cross.weekday==null? 'Todos os dias' : ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'][Cross.weekday]}</span>`);
    wrap.innerHTML = chips.join('');
  }

  // =========================================================
  // CHARTS
  // =========================================================
  const charts = { line:null, day:null, pie:null, heat:null, funnel:null, leaflet:null };

  // ApexCharts base options
  function getApexBaseOptions() {
      const isDark = document.body.classList.contains('dark');
      return {
          chart: {
              foreColor: isDark ? '#e8eaed' : '#222',
              fontFamily: 'Poppins, sans-serif',
              toolbar: { show: false },
              animations: { enabled: true, easing: 'easeinout', speed: 700 }
          },
          tooltip: { theme: isDark ? 'dark' : 'light' },
          dataLabels: { enabled: false }
      };
  }

  function initCharts(){
    // Linha (tend√™ncia)
    charts.line = new ApexCharts(document.querySelector('#line-chart'), {
      ...getApexBaseOptions(),
      chart:{...getApexBaseOptions().chart, type:'area', height:340},
      colors: [getComputedStyle(document.body).getPropertyValue('--brand')],
      stroke:{curve:'smooth', width:3}, fill:{type:'gradient', gradient:{shadeIntensity:.6, opacityFrom:.5, opacityTo:.05}},
      xaxis:{type:'datetime'}, yaxis:{labels:{formatter:(v)=> fmtMoney(v)}},
      tooltip:{
        y:{formatter:(v)=>fmtMoney(v)},
        x:{formatter:(val)=> new Date(val).toLocaleDateString('pt-BR',{month:'short', year:'numeric'})}
      }
    });
    charts.line.render();

    // Barras dia da semana (cross-filter)
    charts.day = new ApexCharts(document.querySelector('#dayofweek-chart'), {
      ...getApexBaseOptions(),
      chart:{...getApexBaseOptions().chart, type:'bar', height:340, events:{
        dataPointSelection: (e, ctx, conf)=>{ Cross.weekday = conf.dataPointIndex; updateActiveChips(); renderAll(); }
      }},
      plotOptions:{bar:{columnWidth:'55%', borderRadius:6}},
      colors: [getComputedStyle(document.body).getPropertyValue('--brand-2')],
      xaxis:{ categories:['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'] },
      tooltip:{ y:{formatter:(v)=> fmtInt(v)+' vendas'} }
    });
    charts.day.render();

    // Donut segmentos
    charts.pie = new ApexCharts(document.querySelector('#pie-chart-segmentos'), {
      ...getApexBaseOptions(),
      chart:{...getApexBaseOptions().chart, type:'donut', height:360},
      legend:{position:'bottom'},
      tooltip:{ y:{formatter:(v,opts)=> `${fmtInt(v)} clientes (${Math.round( (v/opts.series.reduce((a,b)=>a+b,0))*100 )}%)`} }
    });
    charts.pie.render();

    // Heatmap correla√ß√£o
    charts.heat = new ApexCharts(document.querySelector('#corr-heatmap'), {
      ...getApexBaseOptions(),
      chart:{...getApexBaseOptions().chart, type:'heatmap', height:400},
      dataLabels:{enabled:true, formatter:(v)=> v.toFixed(2)},
      colors: [getComputedStyle(document.body).getPropertyValue('--ok')],
      tooltip:{ y:{formatter:(v)=> v.toFixed(3)} }
    });
    charts.heat.render();

    // Funil (ECharts)
    charts.funnel = echarts.init(document.getElementById('funnel-chart'));

    // Mapa (Leaflet)
    charts.leaflet = L.map('br-map', {attributionControl:false}).setView([-15.78, -47.9], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 6}).addTo(charts.leaflet);

    // GeoJSON dos estados do Brasil
    fetch('https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson')
      .then(r=>r.json())
      .then(geo => { window.__BR_GEO__ = geo; renderMapLayer(); });
  }

  let mapLayer = null;
  const UF_MAP = {
    'Acre':'AC','Alagoas':'AL','Amapa':'AP','Amazonas':'AM','Bahia':'BA','Ceara':'CE','Distrito Federal':'DF','Espirito Santo':'ES',
    'Goias':'GO','Maranhao':'MA','Mato Grosso':'MT','Mato Grosso do Sul':'MS','Minas Gerais':'MG','Para':'PA','Paraiba':'PB','Parana':'PR',
    'Pernambuco':'PE','Piaui':'PI','Rio de Janeiro':'RJ','Rio Grande do Norte':'RN','Rio Grande do Sul':'RS','Rondonia':'RO','Roraima':'RR',
    'Santa Catarina':'SC','Sao Paulo':'SP','Sergipe':'SE','Tocantins':'TO','Par√°':'PA','Cear√°':'CE','Goi√°s':'GO','Maranh√£o':'MA','Piau√≠':'PI',
    'Amap√°':'AP','Esp√≠rito Santo':'ES','Mato Grosso do Sul':'MS','Paran√°':'PR','Rond√¥nia':'RO','S√£o Paulo':'SP'
  };
  function nomeToUF(nome){ return UF_MAP[nome] || null; }

  function renderMapLayer(){
    if(!window.__BR_GEO__ || !charts.leaflet) return;
    if(mapLayer){ mapLayer.remove(); mapLayer=null; }
    const filtered = filterData();

    const revPorEstado = filtered.reduce((acc,d)=>{ acc[d.estado_origem] = (acc[d.estado_origem]||0) + (Number(d.receita)||0); return acc; }, {});
    const values = Object.values(revPorEstado);
    const max = values.length? Math.max(...values) : 0;
    const min = values.length? Math.min(...values) : 0;
    
    // Converte hex para RGB
    const hexToRgb = hex => hex.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i, (m, r, g, b) => '#' + r + r + g + g + b + b).substring(1).match(/.{2}/g).map(x => parseInt(x, 16));

    const colorScale = (v)=>{
      if(max===0) return '#e9ecef';
      const t = (v-min)/(max-min+1e-9);
      const brandColor = getComputedStyle(document.body).getPropertyValue('--brand').trim();
      const base = hexToRgb(brandColor);
      const r = Math.round(240 - t* (240-base[0]));
      const g = Math.round(240 - t* (240-base[1]));
      const b = Math.round(240 - t* (240-base[2]));
      return `rgb(${r},${g},${b})`;
    };

    mapLayer = L.geoJSON(window.__BR_GEO__, {
      style: feature => {
        const uf = nomeToUF(feature.properties.name);
        const v = revPorEstado[uf]||0;
        return {color:'#888', weight:1, fillColor: colorScale(v), fillOpacity:.9};
      },
      onEachFeature: (feature, layer) =>{
        const uf = nomeToUF(feature.properties.name);
        const valor = revPorEstado[uf]||0;
        layer.bindPopup(`<strong>${feature.properties.name} (${uf||'‚Äî'})</strong><br>Receita: ${fmtMoney(valor)}`);
        layer.on('click', ()=>{ Cross.estado = uf || null; if(uf){ document.getElementById('filter-origem').value = uf; } updateActiveChips(); renderAll(); });
        layer.on('mouseover', function(){ this.setStyle({weight:2}); });
        layer.on('mouseout', function(){ this.setStyle({weight:1}); });
      }
    }).addTo(charts.leaflet);
  }

  // =========================================================
  // RENDERIZA√á√ÉO (KPIs + CHARTS)
  // =========================================================
  function renderAll(){
    const filtered = filterData();
    const isDark = document.body.classList.contains('dark');
    const brandColor = getComputedStyle(document.body).getPropertyValue('--brand').trim();

    // KPIs
    const receita = filtered.reduce((s,d)=> s+(Number(d.receita)||0), 0);
    const passagens = filtered.reduce((s,d)=> s+(Number(d.passagens)||0), 0);
    const ticket = passagens>0? receita/passagens : 0;
    document.getElementById('kpi-receita').textContent = fmtMoney(receita);
    document.getElementById('kpi-passagens').textContent = fmtInt(passagens);
    document.getElementById('kpi-ticket-medio').textContent = fmtMoney(ticket);

    // Atualiza op√ß√µes e cores dos gr√°ficos ApexCharts
    charts.line.updateOptions({ ...getApexBaseOptions(), colors: [brandColor] });
    charts.day.updateOptions({ ...getApexBaseOptions(), colors: [getComputedStyle(document.body).getPropertyValue('--brand-2').trim()] });
    charts.pie.updateOptions({ ...getApexBaseOptions() });
    charts.heat.updateOptions({ ...getApexBaseOptions(), colors: [getComputedStyle(document.body).getPropertyValue('--ok').trim()] });

    // Tend√™ncia mensal
    const byMonth = {};
    filtered.forEach(d=>{ const k = d.dataObj.toISOString().slice(0,7)+'-01'; byMonth[k]=(byMonth[k]||0)+(Number(d.receita)||0); });
    const lineSeries = Object.keys(byMonth).sort().map(k=>({x:k, y: byMonth[k]}));
    charts.line.updateSeries([{name:'Receita', data: lineSeries}]);

    // Dia da semana
    const dow = Array(7).fill(0);
    filtered.forEach(d=>{ dow[d.dia_semana_num] += 1; });
    charts.day.updateSeries([{name:'Vendas', data:dow}]);

    // Segmentos (donut)
    const seg = {};
    filtered.forEach(d=>{ seg[d.perfil_cliente] = (seg[d.perfil_cliente]||0)+1; });
    const segLabels = Object.keys(seg); const segVals = segLabels.map(k=>seg[k]);
    charts.pie.updateOptions({labels:segLabels});
    charts.pie.updateSeries(segVals);

    // Correla√ß√£o (heatmap) ‚Äî Pearson
    const vars = ['ticket_valor','antecedencia','propensao_compra','pass_num'];
    const pretty = {ticket_valor:'Ticket (R$)', antecedencia:'Anteced√™ncia (d)', propensao_compra:'Propens√£o', pass_num:'Passagens'};
    const corr = calcCorrelationMatrix(filtered, vars);
    const series = vars.map((rowKey, i)=>({ name: pretty[rowKey], data: vars.map((colKey,j)=> ({x: pretty[colKey], y: (corr[i][j]||0)})) }));
    charts.heat.updateSeries(series);

    // Funil (simulado)
    const compras = passagens;
    const carrinho = Math.round(compras / 0.55);
    const busca = Math.round(carrinho / 0.35);
    const visitantes = Math.round(busca / 0.20);
    const funnelData = [
      {name:'Visitantes', value: visitantes},
      {name:'Busca', value: busca},
      {name:'Carrinho', value: carrinho},
      {name:'Compra', value: compras},
    ];
    charts.funnel.setOption({
      backgroundColor: 'transparent',
      textStyle: { color: isDark ? '#e8eaed' : '#222', fontFamily:'Poppins' },
      color: [brandColor, getComputedStyle(document.body).getPropertyValue('--brand-2').trim(), '#a98ee8', '#cbb9f2'],
      tooltip: { trigger:'item', formatter: p=> `${p.name}: <b>${fmtInt(p.value)}</b> (${p.percent}%)` },
      series: [{
        type:'funnel', left:'5%', top:10, bottom:10, width:'90%', minSize:'10%', maxSize:'100%', sort:'descending',
        label: {show:true, formatter: ({name, value})=> `${name}: ${fmtInt(value)}`, color: isDark ? '#fff' : '#222' },
        itemStyle: {opacity:.9},
        data: funnelData
      }]
    });

    // Tabela de alta propens√£o
    const tbody = document.getElementById('prediction-table');
    tbody.innerHTML = '';
    const tops = filtered.filter(d=> Number(d.propensao_compra)>0.7)
                       .sort((a,b)=> b.propensao_compra - a.propensao_compra)
                       .slice(0, 60);
    tops.forEach(d=>{
      const pct = Math.round(d.propensao_compra*100);
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td><span class="badge" style="background:var(--brand-2);">${d.perfil_cliente||'-'}</span></td>
          <td>${d.origem||'-'}</td>
          <td>
            <div class="progress" role="progressbar" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100" title="${pct}%">
              <div class="progress-bar" style="width:${pct}%; background: var(--brand);"></div>
            </div>
          </td>
          <td><button class="btn btn-sm camp-btn" style="--bs-btn-padding-y: .2rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem; border-color:var(--brand); color:var(--brand);" onmouseover="this.style.backgroundColor='var(--brand)'; this.style.color='#fff';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='var(--brand)';" data-seg="${d.perfil_cliente||''}" data-uf="${d.estado_origem||''}" data-pct="${pct}"><i class='bi bi-megaphone'></i> Ativar</button></td>
        </tr>
      `);
    });

    // Contexto selecionado
    const ctxParts = [];
    ctxParts.push(Cross.estado ? `UF: ${Cross.estado}` : 'Todos os estados');
    ctxParts.push(Cross.weekday==null ? 'Todos os dias' : ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'][Cross.weekday]);
    document.getElementById('sel-ctx').textContent = 'Contexto: ' + ctxParts.join(' ‚Ä¢ ');

    // Mapa
    renderMapLayer();

    // handlers da campanha/exports
    bindCampaignActions(tops);
  }

  // Pearson correlation
  function calcCorrelationMatrix(rows, keys){
    const n = keys.length; const out = Array.from({length:n},()=>Array(n).fill(0));
    if(rows.length<3) return out;
    const cols = keys.map(k=> rows.map(r=> Number(r[k])||0 ));
    const means = cols.map(col=> col.reduce((a,b)=>a+b,0)/col.length );
    const stds = cols.map((col,i)=> Math.sqrt(col.reduce((s,v)=> s + Math.pow(v-means[i],2), 0) / (col.length-1)) || 1 );
    for(let i=0;i<n;i++){
      for(let j=0;j<n;j++){
        let cov=0; for(let t=0;t<rows.length;t++){ cov += (cols[i][t]-means[i])*(cols[j][t]-means[j]); }
        cov /= (rows.length-1);
        out[i][j] = (cov)/(stds[i]*stds[j]);
        if(!isFinite(out[i][j])) out[i][j]=0;
        out[i][j] = Math.max(-1, Math.min(1, out[i][j]));
      }
    }
    return out;
  }

  // Exportar PNGs
  async function exportPNGs(){
    try{
      if(charts.line){ const r = await charts.line.dataURI(); downloadURI(r.imgURI, 'tendencia_receita.png'); }
      if(charts.day){ const r = await charts.day.dataURI(); downloadURI(r.imgURI, 'vendas_semana.png'); }
      if(charts.pie){ const r = await charts.pie.dataURI(); downloadURI(r.imgURI, 'segmentos_clientes.png'); }
      if(charts.heat){ const r = await charts.heat.dataURI(); downloadURI(r.imgURI, 'correlacao.png'); }
      if(charts.funnel){
        const uri = charts.funnel.getDataURL({type:'png', pixelRatio:2, backgroundColor: document.body.classList.contains('dark')? '#14181d':'#ffffff'});
        downloadURI(uri, 'funil.png');
      }
    }catch(err){ console.error('Falha ao exportar PNGs', err); }
  }

  // Campanhas
  function bindCampaignActions(rows){
    // Bot√µes em cada linha
    document.querySelectorAll('.camp-btn').forEach(btn=>{
      btn.onclick = ()=>{
        document.getElementById('camp-segmento').value = btn.dataset.seg || '';
        document.getElementById('camp-uf').value = btn.dataset.uf || 'Todos';
        openCampaignPanel();
      };
    });
    // Atalhos
    const openBtn = document.getElementById('btn-abrir-campanha');
    if(openBtn){ openBtn.onclick = ()=> openCampaignPanel(); }
    const exportBtn = document.getElementById('btn-export-rapido');
    if(exportBtn){ exportBtn.onclick = ()=> exportCSV(rows); }

    const btnExport = document.getElementById('btn-export');
    const btnSim = document.getElementById('btn-simular');
    if(btnExport){ btnExport.onclick = ()=> exportCSV(rows); }
    if(btnSim){ btnSim.onclick = ()=> showToast('#toastOk'); }
  }
  function openCampaignPanel(){
    const off = new bootstrap.Offcanvas('#campanhaOffcanvas');
    document.getElementById('camp-uf').value = Cross.estado || 'Todos';
    off.show();
  }
  function exportCSV(rows){
    const headers = ['perfil_cliente','origem','estado_origem','propensao_compra','data'];
    const csv = [headers.join(',')].concat(rows.map(r=>[
      JSON.stringify(r.perfil_cliente||''),
      JSON.stringify(r.origem||''),
      JSON.stringify(r.estado_origem||''),
      (r.propensao_compra||0).toFixed(4),
      (r.dataObj? r.dataObj.toISOString().split('T')[0] : '')
    ].join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'lista_campanha.csv'; a.click();
    URL.revokeObjectURL(url);
  }
  function showToast(sel){ const t = new bootstrap.Toast(document.querySelector(sel)); t.show(); }

  </script>
</body>
</html>